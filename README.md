# Deployment

The deployment uses two tools:    

1. Terraform : https://www.terraform.io        
2. Ansible : https://www.ansible.com/     
 
The deployment has been broken up into two sections

1. Create the infrastructure, this will setup the necessary OpenStack infrastructure
2. Provision the software=, this will upload the required files, register them with docker and execute the Kubernetes deployment.
 
## Terraform

Terraform is a tool that enables you to safely and predictably create, change, and improve infrastructure. It is an open source tool that codifies APIs into declarative configuration files that can be shared amongst team members, treated as code, edited, reviewed, and versioned.

https://www.terraform.io/

Terraform manages the lifecycle of the deployment, the state is persisted in a Terraform state file. The state file gives explicit access to the resources that were provisioned using Terraform.

https://www.terraform.io/docs/commands/index.html

### terraform plan
The Terraform plan command is used to create an execution plan. Terraform performs a refresh, unless explicitly disabled, and then determines what actions are necessary to achieve the desired state specified in the configuration files.

This command is a convenient way to check whether the execution plan for a set of changes matches your expectations without making any changes to real resources or to the state. For example, Terraform plan might be run before deploying SD, to create confidence in what resources it will deploy.

The optional -out argument can be used to save the generated plan to a file for later execution with Terraform apply.

### terraform apply
The Terraform apply command is used to apply the changes required to reach the desired state of the configuration, or the pre-determined set of actions generated by a Terraform plan execution plan.

### terraform destroy
The Terraform destroy command is used to destroy the Terraform-managed infrastructure.

## Ansible
Ansible is software that automates software provisioning, configuration management, and application deployment.

# Running the Deployment

## Part 0: Prerequisites 
The following tenancy information will be required:
 
* OS_TENANT_NAME
* OS_PROJECT_NAME
* OS_USERNAME
* OS_PASSWORD
* OS_AUTH_URL
* OS_REGION_NAME

Terraform uses a state file to keep track of unique resource id's. It is therefore recommended that Terraform is executed from a location that is available to those people who require access, as they will have access to those state files.

Create an instance using: https://ieatatlas01.athtem.eei.ericsson.se/project/images/caee68e0-dfda-4afb-923c-f0ca1b139689/
* Select flavor m1.xlarge
* Select network P3_CEE01_Public
* Select security group default
* Associate a key-pair to the instance, ensuring that you have the private key for the pair

> If you wish to use your own private and public key, you can replace the contents of ./deployment/id_rsa_tf and ./deployment/id_rsa_tf.pub

* Upload the contents of deployment to /sd/
* Copy the kubernetes.qcow2 to the deployment folder
* Copy the software you wish to deploy to the deployment folder

> If you wish to work on multiple deployments, create a folder for each deployment. Then copy the contents os ./deployment into each folder.

## Part 1: Creating the infrastructure

1. cd into /sd/[NAME OF DEPLOYMENT]/infrastructure
2. Edit 00_terraform.tfvars with the tenancy information and any specific project information
2.1 Double check that kubernetes-env.yaml aligns with Terraform variables
3. Run: terraform plan -var-file=00_terraform.tfvars -out sd_plan

> If you are happy with the details of the plan proceed to the next step

4. Run: terraform apply "sd_plan"

> An image, flavor, keypair and heat stack will be created in Openstack

## Part 2: Provisioning the infrastructure

1. cd into /sd/[NAME OF DEPLOYMENT]/provisioning/terraform
2.1 Double check that stringk8s0.sh, stringk8s1.sh, stringk8s2.sh aligns with Terraform variables (this should be automated in future)
3. Run: terraform plan -var-file=00_terraform.tfvars -out sd_plan
> If you are happy with the details of the plan proceed to the next step
4. Run: terraform apply "sd_plan"

> Common errors at this point are:
> 1. No route to host : an instance has failed to start correctly
> 2. Docker daemon has failed to start
> 3. Kubernetes cannot connect to other instances